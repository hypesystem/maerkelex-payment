<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf8">
        <title>Mærkelex Salg</title>
        <style type="text/css">
            @font-face { font-family: "Open Sans"; src: url("/assets/font/OpenSans-Regular.ttf") format("truetype"); }
            @font-face { font-family: "Open Sans Light"; src: url("/assets/font/OpenSans-Light.ttf") format("truetype"); }

            body {
                background: whitesmoke;
                font-family: "Open Sans", sans-serif;
                margin: 0;
                text-align: center;
            }
            .hero {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 400px;
                overflow: hidden;
                z-index: -1;
            }
            .hero .image {
                background-image: url('data:image/jpeg;base64,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');
                filter: blur(7px);
                background-size: cover;
                background-position: center;
                position: absolute;
                left: -9px;
                right: -9px;
                top: -9px;
                bottom: -9px;
            }
            @keyframes fade20 {
                0% { opacity: 0; }
                20% { opacity: 0; }
                100% { opacity: 1; }
            }
            @keyframes fade40 {
                0% { opacity: 0; }
                40% { opacity: 0; }
                100% { opacity: 1; }
            }
            .logo-section {
                position: relative;
                z-index: 2;
                margin: 80px 10px;
            }
            .logo-section img {
                width: 150px;
                height: 150px;
                animation-name: fade20;
                animation-duration: 2.5s;
            }
            .logo-section .tagline {
                color: white;
                text-transform: uppercase;
                font-size: 1.4em;
                font-family: 'Open Sans Light', sans-serif;
                letter-spacing: 24px;
                animation-name: fade40;
                animation-duration: 4s;
                display: inline-block;
                padding-left: 24px;
            }
            .stats-section {
                margin: 35px 5px 50px;
            }
            .stat {
                background: whitesmoke;
                display: inline-block;
                padding: 15px;
                vertical-align: top;
                width: 200px;
                height: 150px;
                box-sizing: border-box;
                margin: 0 5px;
                position: relative;
                margin-bottom: 5px;
            }
            .stat .label {
                text-transform: uppercase;
                font-size: 0.9em;
                display: block;
            }
            .stat .value {
                display: block;
                font-size: 2.2em;
                font-family: 'Open Sans Light', sans-serif;
                font-weight: 200;
            }
            .stat .value-dkk:after {
                content: ' DKK';
                font-size: 0.35em;
                font-weight: bold;
            }
            .stat .description {
                font-size: 0.8em;
                display: block;
                line-height: 95%;
                color: #32323c;
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 15px;
            }
            .container {
                display: inline-block;
                text-align: left;
                position: relative;
                width: 100%;
                max-width: 1000px;
                background: whitesmoke;
            }
            .container nav {
                background: #32323c;
                padding: 13px;
                font-size: 0.9em;
                color: white;
                text-align: center;
            }
            nav .option {
                display: inline-block;
                text-decoration: none;
                background: transparent;
                color: white;
                font-weight: bold;
                border-radius: 14px;
                font-size: 0.9em;
                padding: 4px 8px;
                margin: 2px 7px;
                border: 1px solid rgb(250, 166, 58);
                transition: background 0.2s;
            }
            nav .option:not(.selected):hover {
                background: rgba(250, 166, 58, 0.075);
            }
            nav .option.selected {
                background: rgba(250, 166, 58, 1);
                text-shadow: 0 0 9px rgba(0,0,0,0.85), 0 0 2px rgba(0,0,0,0.2);
            }
            table {
                margin: 0 0 90px;
                font-size: 0.9em;
                border-collapse: collapse;
                width: 100%;
            }
            th:nth-child(1), td:nth-child(1) {
                padding-left: 40px;
            }
            th:nth-child(6), td:nth-child(6) {
                padding-right: 40px;
            }
            th {
                padding: 16px 12px;
                background: rgba(0,0,0,0.1);
                text-align: center;
            }
            td {
                padding: 8px 12px;
                border-bottom: 1px solid rgba(0,0,0,0.1);
            }
            td.date-field {
                font-size: 0.9em;
                text-align: center;
                line-height: 90%;
            }
            td.status {
                font-weight: bold;
                text-align: center;
            }
            td.status .status-date {
                display: block;
                font-size: 0.6em;
                font-weight: normal;
            }
            td.status .status-date:before {
                content: '(';
            }
            td.status .status-date:after {
                content: ')';
            }
            td.income {
                text-align: right;
            }
            td.income:after {
                content: ' DKK';
                font-size: 0.7em;
            }
            td.actions {
                font-size: 0.9em;
            }
            td.more-info {
                display: none;
                background: rgba(0,0,0,0.015);
                padding-bottom: 20px;
                border-bottom: 2px solid rgba(0,0,0,0.25);
            }
            td.more-info .mark-as-sent, td.more-info .see-receipt {
                float: right;
                max-width: 300px;
                width: 100%;
            }
            td.more-info .mark-as-sent div, td.more-info .see-receipt div {
                padding: 2px 8px 8px;
                font-size: 0.9em;
            }
            .btn {
                border: none;
                color: white;
                font-weight: bold;
                font-family: 'Open Sans', sans-serif;
                padding: 6px 5px;
                background: #089fda;
                display: block;
                text-decoration: none;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="hero">
            <div class="image"></div>
        </div>
        <section class="logo-section">
            <img src="/assets/logo.svg"><br>
            <div class="tagline">salg</div>
        </section>
        <section class="stats-section">
            <div class="stat">
                <span class="label">Mærker solgt</span>
                <span class="value">{{ badgesSold }}</span>
                <span class="description">Det totale antal mærker kunder har bestilt</span>
            </div>
            <div class="stat">
                <span class="label">Indtægt</span>
                <span class="value value-dkk">{{ income }}</span>
                <span class="description">Det beløb kunder i alt har betalt for ordrer</span>
            </div>
            <div class="stat">
                <span class="label">Profit</span>
                <span class="value value-dkk">{{ profit }}</span>
                <span class="description">Det beløb I har tjent efter moms og Mærkelex' afgift</span>
            </div>
            <div class="stat">
                <span class="label">Til gode</span>
                <span class="value value-dkk">{{ remainder }}</span>
                <span class="description">Det beløb der fortsat står på jeres konto, som I kan bede om at få udbetalt</span>
            </div>
        </section>
        <div class="container">
            <nav>
                <a href="#" class="option option-all-orders">Alle ordrer</a>
                <a href="#" class="option option-new-orders selected">Nye ordrer</a>
                <a href="#" class="option option-sent-orders">Afsendte ordrer</a>
            </nav>
            <table>
                <thead>
                    <tr>
                        <th title="Oprettelsesdato for ordren">Opr.dato</th>
                        <th>Kunde</th>
                        <th>Status</th>
                        <th>Ordrebeskrivelse</th>
                        <th>Indtægt</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="100">
                            henter data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <script>
        let defaultPageTitle = document.title;
        let unseenOrdersCount = 0;

        var options = [
            {
                cls: "option-all-orders",
                el: document.querySelector(".option-all-orders"),
                filter: function(x) { return true; }
            },
            {
                cls: "option-new-orders",
                el: document.querySelector(".option-new-orders"),
                filter: function(x) { return x.status == "pending"; }
            },
            {
                cls: "option-sent-orders",
                el: document.querySelector(".option-sent-orders"),
                filter: function(x) { return x.status == "dispatched"; }
            }
        ];

        var entries = null;

        options.forEach(function(option) {
            option.el.addEventListener("click", function(e) {
                e.preventDefault();
                options.forEach(function(o) { o.el.classList = "option " + o.cls; });
                this.classList += " selected";

                if(!entries && typeof entries !== "object") {
                    tbody.innerHTML = "<tr><td colspan='1000'>Fejl ved load af ordrer. Prøver igen automatisk. Alternativt kan du forsøge at opdatere siden (tryk F5).</td></tr>";
                }
                else {
                    renderEntriesToList(entries.filter(option.filter));
                }

                return false;
            });
        });

        var tbody = document.querySelector(".container table tbody");

        function renderEntriesToList(entries) {
            if(entries.length < 1) {
                tbody.innerHTML = "<tr><td colspan='1000'>Ingen ordrer i denne kategori.</td></tr>";
                return;
            }
            tbody.innerHTML = renderEntries(entries);
        }

        function renderEntries(entries) {
            return entries.map(entry => {
                return `<tr id="order-${entry.id}">
                    <td class="date-field">${entry.date.replace(" ","<br>")}</td>
                    <td>${entry.customer}</td>
                    <td class="status">${translateStatus(entry.status)}<br><span class="status-date">${entry.statusChangeDate || "?"}</span></td>
                    <td>${entry.description}</td>
                    <td class="income">${entry.total}</td>
                    <td class="actions"><a href="javascript:openOrder('${entry.id}');">Åbn ordre</a></td>
                </tr>
                <tr>
                    <td class="more-info more-info-${entry.id}" colspan="1000">` +
                        (entry.status == "pending" ?
                            `<div class="mark-as-sent">
                                <div>Når du har afsendt ordren til kunden, kan du markere det her, så sendes kvitteringen.</div>
                                <a class="btn" href="/admin/orders/${entry.id}/mark-dispatched">
                                    Marker som afsendt
                                </a>
                            </div>`
                        : "") +
                        (entry.status == "dispatched" ?
                            `<div class="see-receipt">
                                <div>Her kan du se kvitteringen, som blev sendt til kunden.</div>
                                <a class="btn" href="/admin/orders/${entry.id}/receipt" target="_blank">
                                    Se kvittering
                                </a>
                            </div>`
                        : "") +
                        `<strong>Adresse</strong><br>
                        ${entry.address.replace(/\n/g, '<br>')}<br>
                        <br>
                        <strong>Kontaktinformation</strong><br>
                        Email <a href="mailto:${entry.email}">${entry.email}</a><br>
                        Telefon <a href="tel:${entry.phoneNumber}">${entry.phoneNumber}</a><br>
                    </td>
                </tr>`;
            }).join("");
        }

        function translateStatus(status) {
            switch(status) {
                case "pending":
                    return "Ny";
                case "dispatched":
                    return "Afsendt";
                default:
                    return "?";
            }
        }

        function openOrder(id) {
            var entry = entries.find(e => e.id == id);
            var linkField = document.querySelector("#order-" + id + " .actions");
            linkField.innerHTML = '<a href="javascript:closeOrder(\'' + entry.id + '\');">Luk ordre</a>';
            var orderView = document.querySelector(".more-info-" + id);
            orderView.setAttribute("style", "display:table-cell;");
        }

        function closeOrder(id) {
            var entry = entries.find(e => e.id == id);
            var linkField = document.querySelector("#order-" + id + " .actions");
            linkField.innerHTML = '<a href="javascript:openOrder(\'' + entry.id + '\');">Åbn ordre</a>';
            var orderView = document.querySelector(".more-info-" + id);
            orderView.setAttribute("style", "display:none;");
        }

        function loadOrders(backoff) {
            requestOrders((error, orders) => {
                if(error) {
                    console.error("Failed to load entries", error);
                    entries = null;
                    options.find(o => o.cls == "option-new-orders").el.click();
                    return setTimeout(loadOrders, backoff, backoff * 2);
                }
                entries = orders;
                options.find(o => o.cls == "option-new-orders").el.click();
                setInterval(checkForNewOrders, 2 * 60 * 1000); //check every 2 mins
            });
        }

        function requestOrders(callback) {
            var req = new XMLHttpRequest();
            req.open("GET", "/admin/orders");
            req.setRequestHeader("Content-Type", "application/json");
            req.onreadystatechange = function() {
                if(req.readyState != 4) {
                    return;
                }
                if(req.status == 200) {
                    return callback(null, JSON.parse(this.responseText));
                }
                callback({
                    trace: new Error("Error response from server on request"),
                    status: req.statusText,
                    responseType: req.responseType,
                    response: req.response
                });
            };
            req.send();
        }

        function checkForNewOrders() {
            requestOrders((error, orders) => {
                if(error) {
                    return console.error("Failed to poll for updates", error);
                }
                if(orders.length > entries.length) {
                    let diffCount = orders.length - entries.length;
                    new Notification(`${diffCount} ${diffCount > 1 ? "nye ordrer" : "ny ordre"} til Mærkelex!`);
                    let newOrders = orders.filter(order => !entries.some(entry => entry.id == order.id));
                    renderNewOrders(newOrders, diffCount);
                    entries = newOrders.concat(entries);
                }
            });
        }

        function renderNewOrders(newOrders, diffCount) {
            let html = renderEntries(newOrders);
            let elements = htmlToDomElements(html);
            elements = Array.prototype.slice.call(elements).reverse();
            elements.forEach(element => {
                element.style = "transition: background 20s; background:rgb(230, 126, 34);";
                tbody.prepend(element);
            });

            if(document.hasFocus()) {
                setTimeout(() => elements.forEach(element => element.style = "transition: background 20s; background:transparent;"), 0);
            }
            else {
                modifyUnseenOrdersCount(diffCount);
                document.addEventListener("focus", e => elements.forEach(element => {
                    element.style = "transition: background 20s; background:transparent;";
                    modifyUnseenOrdersCount(-diffCount);
                }));
            }
        }

        function htmlToDomElements(html) {
            let container = document.createElement("table");
            container.innerHTML = `<tbody>${html}</tbody>`;
            return container.firstChild.children;
        }

        function modifyUnseenOrdersCount(diff) {
            unseenOrdersCount += diff;
            if(unseenOrdersCount > 0) {
                document.title = `(${unseenOrdersCount}) ${defaultPageTitle}`;
            }
            else {
                document.title = defaultPageTitle;
            }
        }

        loadOrders(200);

        Notification.requestPermission();
        </script>
        <div>
            <form method="post" action="/admin/change-password">
                <input type="password" name="password">
                <button type="submit">Skift kodeord</button>
            </form>
        </div>
        <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-57878677-3', 'auto');
        ga('send', 'pageview');

        </script>
    </body>
</html>
